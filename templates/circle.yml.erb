---
machine:
  services:
    - docker

dependencies:
  pre:
    - sudo pip install ansible-tower-cli

  override:
    - docker build -t quay.io/spartansystems/<%= app_name %> .

database:
  override:
    - echo "skipping"

test:
  override:
    - docker run -d --name=db -p 3306 -e MYSQL_ROOT_PASSWORD=$DATABASE_PASSWORD mysql
    - sleep 5
    - docker run --link=db:db -e DATABASE_HOST=$DATABASE_HOST -e DATABASE_USERNAME=$DATABASE_USERNAME -e DATABASE_PASSWORD=$DATABASE_PASSWORD -e SECRET_KEY_BASE=$SECRET_KEY_BASE -e RAILS_ENV=test quay.io/spartansystems/<%= app_name %> bundle exec rake db:create db:migrate
    - docker run --link=db:db -e DATABASE_HOST=$DATABASE_HOST -e DATABASE_USERNAME=$DATABASE_USERNAME -e DATABASE_PASSWORD=$DATABASE_PASSWORD -e SECRET_KEY_BASE=$SECRET_KEY_BASE quay.io/spartansystems/<%= app_name %> bundle exec rake test

deployment:
  staging:
    branch: master
    commands:
      - docker login -p $DOCKER_PASSWORD -u $DOCKER_USER -e $DOCKER_EMAIL quay.io
      - docker push quay.io/spartansystems/<%= app_name %>:latest
      - tower-cli job launch --monitor --job-template=$STAGING_TOWER_JOB --tower-username $TOWER_USER --tower-password $TOWER_PASSWORD --tower-host $TOWER_HOST
  production:
    branch: production
    commands:
      - docker tag quay.io/spartansystems/<%= app_name %>:latest quay.io/spartansystems/<%= app_name %>:production
      - docker login -p $DOCKER_PASSWORD -u $DOCKER_USER -e $DOCKER_EMAIL quay.io
      - docker push quay.io/spartansystems/<%= app_name %>:production
      - tower-cli job launch --monitor --job-template=$PRODUCTION_TOWER_JOB --tower-username $TOWER_USER --tower-password $TOWER_PASSWORD --tower-host $TOWER_HOST
